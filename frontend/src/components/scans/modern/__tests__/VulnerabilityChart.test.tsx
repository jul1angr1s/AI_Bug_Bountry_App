import { render, screen } from '@testing-library/react';
import VulnerabilityChart from '../VulnerabilityChart';
import type { Finding } from '../../../../lib/api';

describe('VulnerabilityChart', () => {
  const createMockFinding = (overrides: Partial<Finding> = {}): Finding => ({
    id: 'finding-1',
    vulnerabilityType: 'CWE-123',
    severity: 'HIGH',
    status: 'PENDING',
    filePath: '/contracts/Test.sol',
    lineNumber: 42,
    description: 'Test vulnerability',
    confidenceScore: 0.95,
    createdAt: new Date().toISOString(),
    ...overrides,
  });

  describe('Empty state', () => {
    it('displays "No vulnerabilities detected yet" when findings array is empty', () => {
      render(<VulnerabilityChart findings={[]} />);
      expect(screen.getByText('No vulnerabilities detected yet')).toBeInTheDocument();
    });

    it('displays total count of 0 when findings array is empty', () => {
      render(<VulnerabilityChart findings={[]} />);
      expect(screen.getByText('0')).toBeInTheDocument();
    });

    it('displays flat line at zero when findings array is empty', () => {
      const { container } = render(<VulnerabilityChart findings={[]} />);
      const svg = container.querySelector('svg');
      expect(svg).toBeInTheDocument();

      // Check that there's a path element (flat line)
      const path = svg?.querySelector('path');
      expect(path).toBeInTheDocument();
    });

    it('has descriptive ARIA label when empty', () => {
      const { container } = render(<VulnerabilityChart findings={[]} />);
      const svg = container.querySelector('svg');
      expect(svg).toHaveAttribute('aria-label', 'Line chart showing 0 vulnerabilities detected');
    });
  });

  describe('Single finding', () => {
    it('displays total count of 1 when one finding exists', () => {
      const findings = [createMockFinding()];
      render(<VulnerabilityChart findings={findings} />);
      expect(screen.getByText('1')).toBeInTheDocument();
    });

    it('displays horizontal line when only one finding exists', () => {
      const findings = [createMockFinding()];
      const { container } = render(<VulnerabilityChart findings={findings} />);

      // Should have SVG with path elements
      const svg = container.querySelector('svg');
      const paths = svg?.querySelectorAll('path');
      expect(paths).toBeTruthy();
      expect(paths!.length).toBeGreaterThan(0);
    });

    it('displays chart title and metadata', () => {
      const findings = [createMockFinding()];
      render(<VulnerabilityChart findings={findings} />);
      expect(screen.getByText('Vulnerability Detection Rate')).toBeInTheDocument();
    });
  });

  describe('Multiple findings', () => {
    it('displays correct cumulative count', () => {
      const now = Date.now();
      const findings = [
        createMockFinding({ id: '1', createdAt: new Date(now - 20 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '2', createdAt: new Date(now - 15 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '3', createdAt: new Date(now - 10 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '4', createdAt: new Date(now - 5 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '5', createdAt: new Date(now - 1 * 60 * 1000).toISOString() }),
      ];

      render(<VulnerabilityChart findings={findings} />);
      expect(screen.getByText('5')).toBeInTheDocument();
    });

    it('renders SVG line chart with gradient fill', () => {
      const now = Date.now();
      const findings = [
        createMockFinding({ id: '1', createdAt: new Date(now - 20 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '2', createdAt: new Date(now - 10 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '3', createdAt: new Date(now - 5 * 60 * 1000).toISOString() }),
      ];

      const { container } = render(<VulnerabilityChart findings={findings} />);
      const svg = container.querySelector('svg');
      expect(svg).toBeInTheDocument();

      // Check for gradient definition
      const gradient = svg?.querySelector('linearGradient#chartGradient');
      expect(gradient).toBeInTheDocument();

      // Check for gradient stops
      const stops = gradient?.querySelectorAll('stop');
      expect(stops?.length).toBe(2);
      expect(stops?.[0]).toHaveAttribute('stop-color', '#0663f9');
      expect(stops?.[0]).toHaveAttribute('stop-opacity', '0.3');
      expect(stops?.[1]).toHaveAttribute('stop-opacity', '0');
    });

    it('renders endpoint circle with correct styling', () => {
      const now = Date.now();
      const findings = [
        createMockFinding({ id: '1', createdAt: new Date(now - 20 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '2', createdAt: new Date(now - 10 * 60 * 1000).toISOString() }),
      ];

      const { container } = render(<VulnerabilityChart findings={findings} />);
      const circle = container.querySelector('circle');
      expect(circle).toBeInTheDocument();
      expect(circle).toHaveAttribute('r', '4');
      expect(circle).toHaveAttribute('fill', 'white');
      expect(circle).toHaveAttribute('stroke', '#0663f9');
      expect(circle).toHaveAttribute('stroke-width', '2');
    });

    it('displays time window label based on scan duration', () => {
      const now = Date.now();
      const findings = [
        createMockFinding({ id: '1', createdAt: new Date(now - 25 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '2', createdAt: new Date(now - 5 * 60 * 1000).toISOString() }),
      ];

      render(<VulnerabilityChart findings={findings} />);
      // Should display some time window text
      expect(screen.getByText(/Issues found over the last/i)).toBeInTheDocument();
    });

    it('displays axis markers with time labels', () => {
      const now = Date.now();
      const findings = [
        createMockFinding({ id: '1', createdAt: new Date(now - 30 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '2', createdAt: new Date(now - 5 * 60 * 1000).toISOString() }),
      ];

      const { container } = render(<VulnerabilityChart findings={findings} />);
      const svg = container.querySelector('svg');
      const texts = svg?.querySelectorAll('text');

      // Should have at least 3 text elements for axis labels (0m, middle, end)
      expect(texts!.length).toBeGreaterThanOrEqual(3);

      // Check for "0m" label
      const textContents = Array.from(texts || []).map(t => t.textContent);
      expect(textContents).toContain('0m');
    });
  });

  describe('Trend indicator', () => {
    it('displays "+X new" badge when findings detected in last 5 minutes', () => {
      const now = Date.now();
      const findings = [
        createMockFinding({ id: '1', createdAt: new Date(now - 20 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '2', createdAt: new Date(now - 10 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '3', createdAt: new Date(now - 3 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '4', createdAt: new Date(now - 1 * 60 * 1000).toISOString() }),
      ];

      render(<VulnerabilityChart findings={findings} />);
      expect(screen.getByText('+2 new')).toBeInTheDocument();
    });

    it('displays trending-up icon with trend badge', () => {
      const now = Date.now();
      const findings = [
        createMockFinding({ id: '1', createdAt: new Date(now - 3 * 60 * 1000).toISOString() }),
      ];

      render(<VulnerabilityChart findings={findings} />);
      expect(screen.getByText('trending_up')).toBeInTheDocument();
      expect(screen.getByText('+1 new')).toBeInTheDocument();
    });

    it('does not display trend badge when no recent findings', () => {
      const now = Date.now();
      const findings = [
        createMockFinding({ id: '1', createdAt: new Date(now - 20 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '2', createdAt: new Date(now - 10 * 60 * 1000).toISOString() }),
      ];

      render(<VulnerabilityChart findings={findings} />);
      expect(screen.queryByText(/new/)).not.toBeInTheDocument();
    });
  });

  describe('Data transformation', () => {
    it('groups findings into 5-minute intervals', () => {
      const now = Date.now();
      // Create findings spread across different 5-minute intervals
      const findings = [
        createMockFinding({ id: '1', createdAt: new Date(now - 25 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '2', createdAt: new Date(now - 24 * 60 * 1000).toISOString() }), // Same bucket as above
        createMockFinding({ id: '3', createdAt: new Date(now - 15 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '4', createdAt: new Date(now - 5 * 60 * 1000).toISOString() }),
      ];

      const { container } = render(<VulnerabilityChart findings={findings} />);

      // Verify chart renders (data transformation succeeded)
      expect(container.querySelector('svg')).toBeInTheDocument();
      expect(screen.getByText('4')).toBeInTheDocument();
    });

    it('calculates cumulative counts correctly', () => {
      const now = Date.now();
      const findings = [
        createMockFinding({ id: '1', createdAt: new Date(now - 20 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '2', createdAt: new Date(now - 19 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '3', createdAt: new Date(now - 10 * 60 * 1000).toISOString() }),
      ];

      render(<VulnerabilityChart findings={findings} />);
      // Total cumulative count should be 3
      expect(screen.getByText('3')).toBeInTheDocument();
    });

    it('handles findings with same timestamp', () => {
      const timestamp = new Date().toISOString();
      const findings = [
        createMockFinding({ id: '1', createdAt: timestamp }),
        createMockFinding({ id: '2', createdAt: timestamp }),
        createMockFinding({ id: '3', createdAt: timestamp }),
      ];

      const { container } = render(<VulnerabilityChart findings={findings} />);
      expect(container.querySelector('svg')).toBeInTheDocument();
      expect(screen.getByText('3')).toBeInTheDocument();
    });
  });

  describe('Responsive sizing', () => {
    it('uses fixed aspect ratio (478px Ã— 120px)', () => {
      const findings = [createMockFinding()];
      const { container } = render(<VulnerabilityChart findings={findings} />);
      const svg = container.querySelector('svg');

      expect(svg).toHaveAttribute('width', '478');
      expect(svg).toHaveAttribute('height', '120');
      expect(svg).toHaveAttribute('viewBox', '0 0 478 120');
    });

    it('has responsive class for scaling', () => {
      const findings = [createMockFinding()];
      const { container } = render(<VulnerabilityChart findings={findings} />);
      const svg = container.querySelector('svg');

      expect(svg?.classList.contains('w-full')).toBe(true);
      expect(svg?.classList.contains('h-auto')).toBe(true);
    });
  });

  describe('Accessibility', () => {
    it('includes ARIA label with descriptive summary', () => {
      const now = Date.now();
      const findings = [
        createMockFinding({ id: '1', createdAt: new Date(now - 30 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '2', createdAt: new Date(now - 20 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '3', createdAt: new Date(now - 10 * 60 * 1000).toISOString() }),
      ];

      const { container } = render(<VulnerabilityChart findings={findings} />);
      const svg = container.querySelector('svg');

      expect(svg).toHaveAttribute('aria-label');
      expect(svg?.getAttribute('aria-label')).toMatch(/Line chart showing \d+ vulnerabilities/);
    });

    it('includes role="img" on SVG element', () => {
      const findings = [createMockFinding()];
      const { container } = render(<VulnerabilityChart findings={findings} />);
      const svg = container.querySelector('svg');

      expect(svg).toHaveAttribute('role', 'img');
    });

    it('displays total count as text in addition to visual chart', () => {
      const findings = [
        createMockFinding({ id: '1' }),
        createMockFinding({ id: '2' }),
        createMockFinding({ id: '3' }),
      ];

      render(<VulnerabilityChart findings={findings} />);
      // Total count is displayed as text (not just in SVG)
      expect(screen.getByText('3')).toBeInTheDocument();
    });

    it('has descriptive heading for chart', () => {
      const findings = [createMockFinding()];
      render(<VulnerabilityChart findings={findings} />);
      expect(screen.getByText('Vulnerability Detection Rate')).toBeInTheDocument();
    });
  });

  describe('Custom styling', () => {
    it('applies custom className to container', () => {
      const findings = [createMockFinding()];
      const { container } = render(<VulnerabilityChart findings={findings} className="custom-class" />);

      const chartContainer = container.firstChild;
      expect(chartContainer).toHaveClass('custom-class');
    });

    it('uses dark theme colors from Tailwind config', () => {
      const findings = [createMockFinding()];
      const { container } = render(<VulnerabilityChart findings={findings} />);

      const chartContainer = container.firstChild;
      expect(chartContainer).toHaveClass('bg-surface-dark');
      expect(chartContainer).toHaveClass('border-surface-border');
    });
  });

  describe('Edge cases', () => {
    it('handles undefined findings array', () => {
      // @ts-expect-error Testing runtime behavior with undefined
      const { container } = render(<VulnerabilityChart findings={undefined} />);
      expect(container.querySelector('svg')).toBeInTheDocument();
      expect(screen.getByText('No vulnerabilities detected yet')).toBeInTheDocument();
    });

    it('handles very large number of findings', () => {
      const now = Date.now();
      const findings = Array.from({ length: 100 }, (_, i) =>
        createMockFinding({
          id: `finding-${i}`,
          createdAt: new Date(now - (100 - i) * 60 * 1000).toISOString(),
        })
      );

      const { container } = render(<VulnerabilityChart findings={findings} />);
      expect(container.querySelector('svg')).toBeInTheDocument();
      expect(screen.getByText('100')).toBeInTheDocument();
    });

    it('handles findings from the future (clock skew)', () => {
      const now = Date.now();
      const findings = [
        createMockFinding({ id: '1', createdAt: new Date(now + 5 * 60 * 1000).toISOString() }),
        createMockFinding({ id: '2', createdAt: new Date(now + 10 * 60 * 1000).toISOString() }),
      ];

      const { container } = render(<VulnerabilityChart findings={findings} />);
      expect(container.querySelector('svg')).toBeInTheDocument();
      expect(screen.getByText('2')).toBeInTheDocument();
    });
  });
});
